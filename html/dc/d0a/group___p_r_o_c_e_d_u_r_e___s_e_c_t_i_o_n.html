<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>GMACS: tpl FUNCTIONS</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">GMACS
   &#160;<span id="projectnumber">0.1</span>
   </div>
   <div id="projectbrief">Length structured assessment model for crustaceans</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dc/d0a/group___p_r_o_c_e_d_u_r_e___s_e_c_t_i_o_n.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">tpl FUNCTIONS</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:gae64626d2c48849a2b93dfbef31a3e56d"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d0a/group___p_r_o_c_e_d_u_r_e___s_e_c_t_i_o_n.html#gae64626d2c48849a2b93dfbef31a3e56d">calc_sdreport</a> (void)</td></tr>
<tr class="memdesc:gae64626d2c48849a2b93dfbef31a3e56d"><td class="mdescLeft">&#160;</td><td class="mdescRight">calculate sdreport variables in final phase  <a href="#gae64626d2c48849a2b93dfbef31a3e56d">More...</a><br/></td></tr>
<tr class="separator:gae64626d2c48849a2b93dfbef31a3e56d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gab6ce8eaf8d318c1d10155888cd1bb8dc"><td class="memItemLeft" align="right" valign="top">dvar_vector&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d0a/group___p_r_o_c_e_d_u_r_e___s_e_c_t_i_o_n.html#gab6ce8eaf8d318c1d10155888cd1bb8dc">calc_growth_increments</a> (const dvector vSizes, const <a class="el" href="../../de/d39/classivector.html">ivector</a> iSex)</td></tr>
<tr class="memdesc:gab6ce8eaf8d318c1d10155888cd1bb8dc"><td class="mdescLeft">&#160;</td><td class="mdescRight">Compute growth increments.  <a href="#gab6ce8eaf8d318c1d10155888cd1bb8dc">More...</a><br/></td></tr>
<tr class="separator:gab6ce8eaf8d318c1d10155888cd1bb8dc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga77467279a6b22df4773716a1cb576619"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d0a/group___p_r_o_c_e_d_u_r_e___s_e_c_t_i_o_n.html#ga77467279a6b22df4773716a1cb576619">calc_growth_increments</a> (void)</td></tr>
<tr class="memdesc:ga77467279a6b22df4773716a1cb576619"><td class="mdescLeft">&#160;</td><td class="mdescRight">Molt increment as a linear function of pre-molt size.  <a href="#ga77467279a6b22df4773716a1cb576619">More...</a><br/></td></tr>
<tr class="separator:ga77467279a6b22df4773716a1cb576619"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga7b4343d51918847f59db06da7b0d0b3c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d0a/group___p_r_o_c_e_d_u_r_e___s_e_c_t_i_o_n.html#ga7b4343d51918847f59db06da7b0d0b3c">simulation_model</a> (void)</td></tr>
<tr class="memdesc:ga7b4343d51918847f59db06da7b0d0b3c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Simulation model.  <a href="#ga7b4343d51918847f59db06da7b0d0b3c">More...</a><br/></td></tr>
<tr class="separator:ga7b4343d51918847f59db06da7b0d0b3c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gae85542b46a8aa3f80a416a544aac0bbd"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gae85542b46a8aa3f80a416a544aac0bbd">initialize_model_parameters</a> (void)</td></tr>
<tr class="memdesc:gae85542b46a8aa3f80a416a544aac0bbd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize model parameters.  <a href="#gae85542b46a8aa3f80a416a544aac0bbd">More...</a><br/></td></tr>
<tr class="separator:gae85542b46a8aa3f80a416a544aac0bbd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa035770d06c219d3c64d64c178289b80"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa035770d06c219d3c64d64c178289b80">calc_selectivities</a> (void)</td></tr>
<tr class="memdesc:gaa035770d06c219d3c64d64c178289b80"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate selectivies for each gear.  <a href="#gaa035770d06c219d3c64d64c178289b80">More...</a><br/></td></tr>
<tr class="separator:gaa035770d06c219d3c64d64c178289b80"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga77262a9f728d0ed54b8fbea2493603a9"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga77262a9f728d0ed54b8fbea2493603a9">calc_fishing_mortality</a> (void)</td></tr>
<tr class="memdesc:ga77262a9f728d0ed54b8fbea2493603a9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate fishing mortality rates for each fleet.  <a href="#ga77262a9f728d0ed54b8fbea2493603a9">More...</a><br/></td></tr>
<tr class="separator:ga77262a9f728d0ed54b8fbea2493603a9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gac1a6684e8544e37f2989b1f388c1275f"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gac1a6684e8544e37f2989b1f388c1275f">calc_size_transition_matrix</a> (void)</td></tr>
<tr class="memdesc:gac1a6684e8544e37f2989b1f388c1275f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calclate the size transtion matrix.  Steven Martell.  <a href="#gac1a6684e8544e37f2989b1f388c1275f">More...</a><br/></td></tr>
<tr class="separator:gac1a6684e8544e37f2989b1f388c1275f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga326df5834d3e690b6c81daac1c3ffe23"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga326df5834d3e690b6c81daac1c3ffe23">calc_natural_mortality</a> (void)</td></tr>
<tr class="memdesc:ga326df5834d3e690b6c81daac1c3ffe23"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate natural mortality array.  <a href="#ga326df5834d3e690b6c81daac1c3ffe23">More...</a><br/></td></tr>
<tr class="separator:ga326df5834d3e690b6c81daac1c3ffe23"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga9452e86de816c0c965273a0e38033ea6"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga9452e86de816c0c965273a0e38033ea6">calc_total_mortality</a> (void)</td></tr>
<tr class="memdesc:ga9452e86de816c0c965273a0e38033ea6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate total instantaneous mortality rate and survival rate.  <a href="#ga9452e86de816c0c965273a0e38033ea6">More...</a><br/></td></tr>
<tr class="separator:ga9452e86de816c0c965273a0e38033ea6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga865bc170e18ca7280bd96a9ff7e424b4"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga865bc170e18ca7280bd96a9ff7e424b4">calc_molting_probability</a> (void)</td></tr>
<tr class="memdesc:ga865bc170e18ca7280bd96a9ff7e424b4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate the probability of moulting vs carapace width.  <a href="#ga865bc170e18ca7280bd96a9ff7e424b4">More...</a><br/></td></tr>
<tr class="separator:ga865bc170e18ca7280bd96a9ff7e424b4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga8b2e44a401baa0eb9bac5c30dcf017c4"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga8b2e44a401baa0eb9bac5c30dcf017c4">calc_recruitment_size_distribution</a> (void)</td></tr>
<tr class="memdesc:ga8b2e44a401baa0eb9bac5c30dcf017c4"><td class="mdescLeft">&#160;</td><td class="mdescRight">calculate size distribution for new recuits.  <a href="#ga8b2e44a401baa0eb9bac5c30dcf017c4">More...</a><br/></td></tr>
<tr class="separator:ga8b2e44a401baa0eb9bac5c30dcf017c4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa38ab7820a92f3ed99b6a69a28e04649"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa38ab7820a92f3ed99b6a69a28e04649">calc_initial_numbers_at_length</a> (void)</td></tr>
<tr class="memdesc:gaa38ab7820a92f3ed99b6a69a28e04649"><td class="mdescLeft">&#160;</td><td class="mdescRight">initialiaze populations numbers-at-length in syr  <a href="#gaa38ab7820a92f3ed99b6a69a28e04649">More...</a><br/></td></tr>
<tr class="separator:gaa38ab7820a92f3ed99b6a69a28e04649"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gab3680df9e34f65fca8c25d4f67857108"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gab3680df9e34f65fca8c25d4f67857108">update_population_numbers_at_length</a> (void)</td></tr>
<tr class="memdesc:gab3680df9e34f65fca8c25d4f67857108"><td class="mdescLeft">&#160;</td><td class="mdescRight">Update numbers-at-length.  <a href="#gab3680df9e34f65fca8c25d4f67857108">More...</a><br/></td></tr>
<tr class="separator:gab3680df9e34f65fca8c25d4f67857108"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga7507930a25ff4d0e9441f9067b09250f"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga7507930a25ff4d0e9441f9067b09250f">calc_predicted_catch</a> (void)</td></tr>
<tr class="memdesc:ga7507930a25ff4d0e9441f9067b09250f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate predicted catch observations.  <a href="#ga7507930a25ff4d0e9441f9067b09250f">More...</a><br/></td></tr>
<tr class="separator:ga7507930a25ff4d0e9441f9067b09250f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga4f38a22aed2071f65143eeedeb247441"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga4f38a22aed2071f65143eeedeb247441">calc_relative_abundance</a> (void)</td></tr>
<tr class="memdesc:ga4f38a22aed2071f65143eeedeb247441"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate predicted relative abundance and residuals.  <a href="#ga4f38a22aed2071f65143eeedeb247441">More...</a><br/></td></tr>
<tr class="separator:ga4f38a22aed2071f65143eeedeb247441"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gab57c8791f16f8993c86a02ecc28c6a06"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gab57c8791f16f8993c86a02ecc28c6a06">calc_predicted_composition</a> (void)</td></tr>
<tr class="memdesc:gab57c8791f16f8993c86a02ecc28c6a06"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate predicted size composition data.  <a href="#gab57c8791f16f8993c86a02ecc28c6a06">More...</a><br/></td></tr>
<tr class="separator:gab57c8791f16f8993c86a02ecc28c6a06"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa7ba0662d9d1f96922dad9831a0eba75"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa7ba0662d9d1f96922dad9831a0eba75">calculate_prior_densities</a> (void)</td></tr>
<tr class="memdesc:gaa7ba0662d9d1f96922dad9831a0eba75"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate prior density functions for leading parameters.  <a href="#gaa7ba0662d9d1f96922dad9831a0eba75">More...</a><br/></td></tr>
<tr class="separator:gaa7ba0662d9d1f96922dad9831a0eba75"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga075ae026c3da2bbd3fb02f2aca36905f"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga075ae026c3da2bbd3fb02f2aca36905f">calc_objective_function</a> (void)</td></tr>
<tr class="memdesc:ga075ae026c3da2bbd3fb02f2aca36905f"><td class="mdescLeft">&#160;</td><td class="mdescRight">calculate objective function  <a href="#ga075ae026c3da2bbd3fb02f2aca36905f">More...</a><br/></td></tr>
<tr class="separator:ga075ae026c3da2bbd3fb02f2aca36905f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>FUNCTIONS declared in the tpl PROCEDURE_SECTION. </p>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="ga77262a9f728d0ed54b8fbea2493603a9"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calc_fishing_mortality </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculate fishing mortality rates for each fleet. </p>
<p>For each fleet estimate scaler log_fbar and deviates (f_devs). </p>
<pre class="fragment"> In the event that there is effort data and catch data, then it's possible
 to estimate a catchability coefficient and predict the catch for the
 period of missing catch/discard data.  Best option for this would be
 to use F = q*E, where q = F/E.  Then in the objective function, minimize
 the variance in the estimates of q, and use the mean q to predict catch.
 Or minimize the first difference and assume a random walk in q.

 Note that this function calculates the fishing mortality rate including
 deaths due to discards.  Where lambda is the discard mortality rate.

 Note also that Jie estimates F for retained fishery, f for male discards and
 f for female discards.  Not recommended to have separate F' for retained and 
 discard fisheries, but might be ok to have sex-specific F's.  

 TODO fix discard mortality rate.</pre> <p>Molt increment as a linear function of pre-molt size.</p>
<p>TODO Option for empirical molt increments.</p>

<p>Definition at line <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html#l00877">877</a> of file <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html">gmacs.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;{</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;    <span class="keywordtype">int</span> h,i,k,ik,yk;</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    <span class="keywordtype">double</span> lambda;      <span class="comment">// discard mortality rate</span></div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga55e662f32ff984a525bbd362c2f3d617" title="Total mortality ">F</a>.initialize();</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga218e4fe012e1afdab85c09517d890e4f" title="Numbers-at-sex/mature/shell/length. ">ft</a>.initialize();</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;    dvariable log_ftmp;</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;    dvar_vector sel(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    dvar_vector ret(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    dvar_vector tmp(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    <span class="keywordflow">for</span>( k = 1; k &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga20b8c3de4b867dab041850cf0b25dfb0" title="time step (years) ">nfleet</a>; k++ )</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    {</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        <span class="keywordflow">for</span>( h = 1; h &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabba2a6095b2a11a9007f29453bdc11e6" title="number of gears ">nsex</a>; h++ )</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;        {</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;            ik=1; yk=1;</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;            <span class="keywordflow">for</span>( i = syr; i &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabf19890366959e62b9f5fd444807a2d3" title="initial year ">nyr</a>; i++ )</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;            {</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;                <span class="keywordflow">if</span>(fhit(i,k))</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;                {</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;                    log_ftmp    = log_fbar(k) + log_fdev(k,ik++);</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;                    <span class="keywordflow">if</span>(yhit(i,k))</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;                    {</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;                        log_ftmp   += (h-1) * (log_foff(k) + log_fdov(k,yk++));</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;                    }</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;                    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga218e4fe012e1afdab85c09517d890e4f" title="Numbers-at-sex/mature/shell/length. ">ft</a>(k)(h)(i) = mfexp(log_ftmp);</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;                    lambda = dmr(i,k);</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;                    sel = exp(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga24a2d92bd04b39df15797453566714f1" title="Surival Rate (S=exp(-Z)) ">log_slx_capture</a>(k)(h)(i));</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;                    ret = exp(log_slx_retaind(k)(h)(i)) * slx_nret(h,k);</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;                    tmp = elem_prod(sel,ret + (1.0 - ret) * lambda);</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;                    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga55e662f32ff984a525bbd362c2f3d617" title="Total mortality ">F</a>(h)(i) += <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga218e4fe012e1afdab85c09517d890e4f" title="Numbers-at-sex/mature/shell/length. ">ft</a>(k,h,i) * tmp;</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;                }</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;            }</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;        }</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    }</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="gab6ce8eaf8d318c1d10155888cd1bb8dc"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">dvar_vector model_parameters::calc_growth_increments </td>
          <td>(</td>
          <td class="paramtype">const dvector&#160;</td>
          <td class="paramname"><em>vSizes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="../../de/d39/classivector.html">ivector</a>&#160;</td>
          <td class="paramname"><em>iSex</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Compute growth increments. </p>
<p>Presently based on liner form</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">vSizes</td><td>is a vector of size data from which to compute predicted values </td></tr>
    <tr><td class="paramname">iSex</td><td>is an integer vector indexing sex (1 = male, 2 = female ) </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>dvar_vector of predicted growth increments </dd></dl>
<p>Calclate the size transtion matrix.  Steven Martell</p>
<p>Calculates the size transition matrix for each sex based on growth increments, which is a linear function of the size interval, and the scale parameter for the gamma distribution. This function does the proper integration from the lower to upper size bin, where the mode of the growth increment is scaled by the scale parameter.</p>
<p>This function loops over sex, then loops over the rows of the size transition matrix for each sex. The probability of transitioning from size l to size ll is based on the vector molt_increment and the scale parameter. In all there are three parameters that define the size transition matrix (alpha, beta, scale) for each sex.</p>
<p>Modified Dec 11, 2014. Diagonal of the matrix now represents probability of not molting, and upper triangle is the probability of growing to the next size interval given you molted.</p>
<p>Dec 20. Undid the above modification after correspondence with Jack Turnock. He rightly pointed out that it is possible to molt and remain in the same bin interval (if the intervals are sufficiently large).</p>
<p>Jan 11, 2015. Checked cumd_gamma function in ADMB with R. This is the same function as pgamma with the rate parameter set at its default value 1.0. The mean value of the function is the second argument of cumd_gamma, and the vector of quantiles is the first argument. Both arguments are scaled by gscale.</p>

<p>Definition at line <a class="el" href="../../dd/da9/gmacs_8tpl_source.html#l01292">1292</a> of file <a class="el" href="../../dd/da9/gmacs_8tpl_source.html">gmacs.tpl</a>.</p>
<div class="fragment"><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;                 :  See note from Dave Fournier.</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;     * </div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;     * For the initial numbers-at-lengt a <a class="code" href="../../d7/dfc/classvector.html">vector</a> of deviates is estimated,</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;     * one <span class="keywordflow">for each</span> size <span class="keyword">class</span>, and have the option to initialize</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;     * the model at unfished equilibrium, or some other steady state condition.</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;     *  </div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;     *  Dec 11, 2014. Martell &amp; Ianelli at snowgoose.  We had a discussion regarding</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;     *  how to deal with the joint probability of molting and growing to a <span class="keyword">new</span> size</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;     *  interval <span class="keywordflow">for</span> a given length, and the probability of not molting.  We settled </div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;     *  on <span class="keyword">using</span> the size-tranistion <a class="code" href="../../d1/d8d/classmatrix.html">matrix</a> to represent <span class="keyword">this</span> joint probability, where</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;     *  the diagonal of the <a class="code" href="../../d1/d8d/classmatrix.html">matrix</a> to represent the probability of surviving and </div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;     *  molting to a <span class="keyword">new</span> size interval. The upper diagonal of the size-transition <a class="code" href="../../d1/d8d/classmatrix.html">matrix</a></div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;     *  represent the probability of growing to size interval j<span class="stringliteral">&#39; given size interval j.</span></div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;<span class="stringliteral">     *  </span></div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;<span class="stringliteral">     *  Oldshell crabs are then the column vector of 1-molt_probabiltiy times the </span></div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;<span class="stringliteral">     *  numbers-at-length, and the Newshell crabs is the column vector of molt_probability</span></div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;<span class="stringliteral">     *  times the number-at-length.</span></div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;<span class="stringliteral">     *  </span></div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;<span class="stringliteral">     *  Jan 1, 2015.  Changed how the equilibrium calculation is done.  Use a numerical</span></div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;<span class="stringliteral">     *  approach to solve the newshell oldshell initial abundance.</span></div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;<span class="stringliteral">     *  </span></div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;<span class="stringliteral">     *  –––-—————————————————————————————————————————————————————————————————————————----</span></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga77467279a6b22df4773716a1cb576619"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void model_parameters::calc_growth_increments </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Molt increment as a linear function of pre-molt size. </p>
<p>TODO Option for empirical molt increments. </p>
<p>Compute growth increments</p>
<p>Presently based on liner form</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">vSizes</td><td>is a vector of size data from which to compute predicted values </td></tr>
    <tr><td class="paramname">iSex</td><td>is an integer vector indexing sex (1 = male, 2 = female ) </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>dvar_vector of predicted growth increments</dd></dl>

<p>Definition at line <a class="el" href="../../dd/da9/gmacs_8tpl_source.html#l01326">1326</a> of file <a class="el" href="../../dd/da9/gmacs_8tpl_source.html">gmacs.tpl</a>.</p>
<div class="fragment"><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;              :</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;     *      o = n(I-<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6ec7754e2a4d12b5b249462c6d17af05" title="Fishing mortality ">P</a>)S[I-(I-<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6ec7754e2a4d12b5b249462c6d17af05" title="Fishing mortality ">P</a>)S]^(-1)              (3)</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;     *  next substitute (3) into (1) and solve for n</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;     *      n = nPSA + n(I-<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6ec7754e2a4d12b5b249462c6d17af05" title="Fishing mortality ">P</a>)S[I-(I-<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6ec7754e2a4d12b5b249462c6d17af05" title="Fishing mortality ">P</a>)S]^(-1)PSA + r</div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;     *  </div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;     *  let B = [I-(I-<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6ec7754e2a4d12b5b249462c6d17af05" title="Fishing mortality ">P</a>)S]^(-1)</div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;     *      </div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;     *      n - nPSA - n(I-<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6ec7754e2a4d12b5b249462c6d17af05" title="Fishing mortality ">P</a>)SBPSA = r</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;     *      n(I - PSA - (I-<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6ec7754e2a4d12b5b249462c6d17af05" title="Fishing mortality ">P</a>)SBPSA) = r</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="gaa38ab7820a92f3ed99b6a69a28e04649"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calc_initial_numbers_at_length </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>initialiaze populations numbers-at-length in syr </p>
<dl class="section author"><dt>Author</dt><dd>Steve Martell</dd></dl>
<p>This function initializes the populations numbers-at-length in the initial year of the model.</p>
<p>Psuedocode: See note from Dave Fournier.</p>
<p>For the initial numbers-at-lengt a vector of deviates is estimated, one for each size class, and have the option to initialize the model at unfished equilibrium, or some other steady state condition.</p>
<p>Dec 11, 2014. Martell &amp; Ianelli at snowgoose. We had a discussion regarding how to deal with the joint probability of molting and growing to a new size interval for a given length, and the probability of not molting. We settled on using the size-tranistion matrix to represent this joint probability, where the diagonal of the matrix to represent the probability of surviving and molting to a new size interval. The upper diagonal of the size-transition matrix represent the probability of growing to size interval j' given size interval j.</p>
<p>Oldshell crabs are then the column vector of 1-molt_probabiltiy times the numbers-at-length, and the Newshell crabs is the column vector of molt_probability times the number-at-length.</p>
<p>Jan 1, 2015. Changed how the equilibrium calculation is done. Use a numerical approach to solve the newshell oldshell initial abundance.</p>
<p>–––-—————————————————————————————————————————————————————————————————————————-&mdash; Jan 3, 2015. Working with John Levitt on analytical solution instead of the numerical approach. Think we have a soln.</p>
<p>Notation: n = vector of newshell crabs o = vector of oldshell crabs P = diagonal matrix of molting probabilities by size S = diagonal matrix of survival rates by size A = Size transition matrix. r = vector of new recruits (newshell) I = identity matrix.</p>
<p>The following equations represent the dynamics of newshell and oldshell crabs. n = nSPA + oSPA + r (1) o = oS(I-P)A + nS(I-P)A (2) Objective is to solve the above equations for n and o repsectively. Starting with o: o = n(I-P)S[I-(I-P)S]^(-1) (3) next substitute (3) into (1) and solve for n n = nPSA + n(I-P)S[I-(I-P)S]^(-1)PSA + r</p>
<p>let B = [I-(I-P)S]^(-1) </p>
<pre class="fragment">n - nPSA - n(I-P)SBPSA = r
n(I - PSA - (I-P)SBPSA) = r
</pre><p>let C = (I - PSA - (I-P)SBPSA)</p>
<p>then n = C^(-1) r (4) –––-—————————————————————————————————————————————————————————————————————————-&mdash; –––-—————————————————————————————————————————————————————————————————————————-&mdash; </p>
<p>Update numbers-at-length </p>
<dl class="section author"><dt>Author</dt><dd>Steve Martell</dd></dl>
<p>Numbers at length are propagated each year for each sex based on the size transition matrix and a vector of size-specifc survival rates. The columns of the size-transition matrix are multiplied by the size-specific survival rate (a sclaer). New recruits are added based on the estimated aveerage recruitment and annual deviate, multiplied by a vector of size-proportions (rec_sdd).</p>

<p>Definition at line <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html#l01219">1219</a> of file <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html">gmacs.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;{</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;    dvariable log_initial_recruits;</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;    <span class="comment">//N.initialize();</span></div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga392baa5af413ffcb0b15616fec7fe8b8" title="Fishing mortality by gear ">d3_newShell</a>.initialize();</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gac0f3eb81bfb73d6affa8f2b08016e126" title="New shell crabs-at-length. ">d3_oldShell</a>.initialize();</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;    <span class="comment">// Initial recrutment.</span></div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaae5ebb403ffa2a1ad5ced233a454fa59" title="Flag to print to screen ">bInitializeUnfished</a> )</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;    {</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;        log_initial_recruits = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga399cfcaa6f8f749cd20fd5bd69f79681" title="natural mortality rate ">logR0</a>;</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;    }</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;    {</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;        log_initial_recruits = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga8d892ae3b2fb367d3a65cbfe670462c4" title="logarithm of average recruits(syr+1,nyr) ">logRini</a>;</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;    }</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga19c444af05f8f323c313ca49164f4b19" title="recruitment size_density_distribution ">recruits</a>(syr) = exp(log_initial_recruits);</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;    dvar_vector rt = 0.5 * <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga19c444af05f8f323c313ca49164f4b19" title="recruitment size_density_distribution ">recruits</a>(syr) * <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga5b257b9793f2f889ce2b21ec6db4e3d7" title="CV in molting probabilility. ">rec_sdd</a>;</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    <span class="comment">// Analytical equilibrium soln.</span></div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;    <span class="keywordtype">int</span> ig;</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>.initialize();</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;    dmatrix Id = identity_matrix(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;    dvar_vector  x(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;    dvar_vector  y(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;    dvar_matrix  A(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>,1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> h = 1; h &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabba2a6095b2a11a9007f29453bdc11e6" title="number of gears ">nsex</a>; h++ )</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;    {</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;        A = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga1552a2cce597930be686a3afed42e4f7" title="probability of molting ">size_transition</a>(h);</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;        <span class="comment">// Single shell condition</span></div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;        <span class="keywordflow">if</span> ( <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa47ab609d7d0b95e04a7f35c9364975e" title="number of sexes ">nshell</a> == 1 &amp;&amp; <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga5ed63c324f88eb6a15b3e2b2c136ec70" title="number of shell conditions ">nmature</a> == 1)</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;        {</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;            <a class="code" href="../../d1/d8d/group___g_m_a_c_s.html#ga2b098adcfcf6ed4e11048332c84ee202" title="Calculate equilibrium vector n given A, S and r. ">calc_equilibrium</a>(x,A,S(h)(syr),rt);</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;            ig = pntr_hmo(h,1,1);</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;            <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(syr) = elem_prod(x , exp(rec_ini));</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;        }</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;        <span class="comment">// Continuous molt (newshell/oldshell)</span></div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;        <span class="keywordflow">if</span> ( <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa47ab609d7d0b95e04a7f35c9364975e" title="number of sexes ">nshell</a> == 2 &amp;&amp; <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga5ed63c324f88eb6a15b3e2b2c136ec70" title="number of shell conditions ">nmature</a> == 1)</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;        {</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;            <a class="code" href="../../d1/d8d/group___g_m_a_c_s.html#ga2b098adcfcf6ed4e11048332c84ee202" title="Calculate equilibrium vector n given A, S and r. ">calc_equilibrium</a>(x,y,A,S(h)(syr),<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6ec7754e2a4d12b5b249462c6d17af05" title="Fishing mortality ">P</a>(h),rt);</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;            ig = pntr_hmo(h,1,1);</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;            <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(syr) = elem_prod(x , exp(rec_ini));;</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;            <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig+1)(syr) = elem_prod(y , exp(rec_ini));;</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;        }</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;        <span class="comment">// Insert terminal molt case here.</span></div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;    }</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;    <span class="comment">// cout&lt;&lt;&quot;End of calc_initial_numbers_at_length&quot;&lt;&lt;endl;</span></div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;    <span class="comment">// DEPRECATE, used for checking analytical soln.</span></div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;    <span class="comment">// Solve for stable distribution numerically.</span></div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;    <span class="comment">// int ig,h,o,m;</span></div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;    <span class="comment">// int iter = 0;</span></div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa9e289eddb591991c9bc7321dc5b186b" title="Estimated rec_dev phase ">verbose</a>) COUT(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(1)(syr));</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga865bc170e18ca7280bd96a9ff7e424b4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calc_molting_probability </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculate the probability of moulting vs carapace width. </p>
<p>Note that the parameters molt_mu and molt cv can only be estimated in cases where there is new shell and old shell data.</p>
<p>Note that the diagonal of the P matrix != 0, otherwise the matrix is singular in inv(P). </p>
<p>calculate size distribution for new recuits.</p>
<p>Based on the gamma distribution, calculates the probability of a new recruit being in size-interval size.</p>
<p>TODO: fix the scale on cumd_gamma distribution so beta rbeta is estimable.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ra</td><td>is the mean of the distribution. </td></tr>
    <tr><td class="paramname">rbeta</td><td>scales the variance of the distribution</td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html#l01117">1117</a> of file <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html">gmacs.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;{</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;    <span class="keywordtype">int</span> l,h;</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gaf2ead1e3f78fe5ede3ebac728c52947d" title="linear molt increment ">molt_probability</a>.initialize();</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6ec7754e2a4d12b5b249462c6d17af05" title="Fishing mortality ">P</a>.initialize();</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;    <span class="keywordtype">double</span> tiny = 0.001;</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;    <span class="keywordflow">for</span>( h = 1; h &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabba2a6095b2a11a9007f29453bdc11e6" title="number of gears ">nsex</a>; h++ )</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;    {</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;        dvariable mu = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga3069844c614bbb10dbbd3524697d62d4" title="scale parameter for the gamma distribution. ">molt_mu</a>(h);</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;        dvariable sd = mu* <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga736952a304ae8a0b15ea2b82e4da551e" title="50% probability of molting at length each year. ">molt_cv</a>(h);</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;        <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gaf2ead1e3f78fe5ede3ebac728c52947d" title="linear molt increment ">molt_probability</a>(h) = 1.0 - ((1.0-2.*tiny)*plogis(mid_points,mu,sd) + tiny);</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;        <span class="keywordflow">for</span>( l = 1; l &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>; l++ )</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;        {</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;            <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6ec7754e2a4d12b5b249462c6d17af05" title="Fishing mortality ">P</a>(h)(l,l) = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gaf2ead1e3f78fe5ede3ebac728c52947d" title="linear molt increment ">molt_probability</a>(h)(l);</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;        }</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    }</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga326df5834d3e690b6c81daac1c3ffe23"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calc_natural_mortality </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculate natural mortality array. </p>
<p>Natural mortality (M) is a 3d array for sex, year and size. </p>
<dl class="section return"><dt>Returns</dt><dd>NULL <pre class="fragment"> todo:  
      - Add time varying components
      - Size-dependent mortality</pre> </dd></dl>
<p>Calculate total instantaneous mortality rate and survival rate</p>
<p>\( S = exp(-Z) \) </p>
<dl class="section return"><dt>Returns</dt><dd>NULL</dd></dl>

<p>Definition at line <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html#l01029">1029</a> of file <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html">gmacs.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;{</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;    <span class="keywordtype">int</span> h;</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;    M.initialize();</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;    <span class="keywordflow">for</span>( h = 1; h &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabba2a6095b2a11a9007f29453bdc11e6" title="number of gears ">nsex</a>; h++ )</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;    {</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;        M(h) = M0;</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;    }</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;    <span class="comment">// Add random walk to natural mortality rate.</span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;    <span class="keywordflow">if</span> (active( <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6cd4f76f01d8bf64a6835786b5194266" title="recruitment deviations ">m_dev</a> ))</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;    {</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;        dvar_vector delta(syr+1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabf19890366959e62b9f5fd444807a2d3" title="initial year ">nyr</a>);</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;        delta.initialize();</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;        <span class="keywordflow">switch</span>( m_type )</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;        {</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;            <span class="comment">// would this line ever occur if m_dev active?</span></div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;            <span class="keywordflow">case</span> 0:  <span class="comment">// constant natural mortality</span></div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;                delta = 0;</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;            <span class="keywordflow">case</span> 1:  <span class="comment">// random walk in natural mortality</span></div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;                delta = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6cd4f76f01d8bf64a6835786b5194266" title="recruitment deviations ">m_dev</a>.shift(syr+1);</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;            <span class="keywordflow">case</span> 2:  <span class="comment">// cubic splines</span></div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;            {</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;                dvector iyr = (m_nodeyear -syr) / (<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabf19890366959e62b9f5fd444807a2d3" title="initial year ">nyr</a>-syr);</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;                dvector jyr(syr+1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabf19890366959e62b9f5fd444807a2d3" title="initial year ">nyr</a>);</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;                jyr.fill_seqadd(0,1./(<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabf19890366959e62b9f5fd444807a2d3" title="initial year ">nyr</a>-syr-1));</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;                vcubic_spline_function csf(iyr,<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6cd4f76f01d8bf64a6835786b5194266" title="recruitment deviations ">m_dev</a>);</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;                delta = csf(jyr);</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;            }</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;<span class="comment">            JIm Question about below.  I&#39;m not sure if you were intending to</span></div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;<span class="comment">            have this set up as a random walk, where the shift occurs in a specifc year</span></div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;<span class="comment">            to a new state.  I think what Jie had  was just a block wiht a different</span></div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;<span class="comment">            M and it then returns back to the previous state.</span></div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;<span class="comment">            */</span></div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;            <span class="keywordflow">case</span> 3:  <span class="comment">// Specific break points</span></div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;              <span class="keywordflow">for</span> (<span class="keywordtype">int</span> idev=1;idev&lt;=nMdev;idev++)</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;              {</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;                delta(m_nodeyear(idev)) = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6cd4f76f01d8bf64a6835786b5194266" title="recruitment deviations ">m_dev</a>(idev);</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;              }</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;        }</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;        <span class="comment">// Update M by year.</span></div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> h = 1; h &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabba2a6095b2a11a9007f29453bdc11e6" title="number of gears ">nsex</a>; h++ )</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;        {</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = syr+1; i &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabf19890366959e62b9f5fd444807a2d3" title="initial year ">nyr</a>; i++ )</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;            {</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;                M(h)(i)  = M(h)(i-1) * mfexp(delta(i));</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;            }</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;        }</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;    }</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga075ae026c3da2bbd3fb02f2aca36905f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calc_objective_function </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>calculate objective function </p>
<p>Likelihood components</p>
<ol type="1">
<li>likelihood of the catch data (assume lognormal error)</li>
<li>likelihood of relative abundance data</li>
<li>likelihood of size composition data</li>
</ol>
<p>Penalty components</p>
<ol type="1">
<li>Penalty on log_fdev to ensure they sum to zero.</li>
<li>Penalty to regularize values of log_fbar.</li>
<li>Penalty to constrain random walk in natural mortaliy rates </li>
</ol>
<p>Simulation model</p>
<p>Uses many of the same routines as the assessment model, over-writes the observed data in memory with simulated data.</p>

<p>Definition at line <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html#l01755">1755</a> of file <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html">gmacs.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;{</div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;    <span class="comment">// |---------------------------------------------------------------------------------|</span></div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;    <span class="comment">// | NEGATIVE LOGLIKELIHOOD COMPONENTS FOR THE OBJECTIVE FUNCTION                    |</span></div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;    <span class="comment">// |---------------------------------------------------------------------------------|</span></div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;    nloglike.initialize();</div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;    <span class="comment">// 1) Likelihood of the catch data.</span></div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa9e289eddb591991c9bc7321dc5b186b" title="Estimated rec_dev phase ">verbose</a>) COUT(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga3eb45edd19d01d158f8267ca8fe0e62a" title="predicted catch (Baranov eq) ">res_catch</a>(1));</div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k = 1; k &lt;= nCatchDF; k++ )</div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;    {</div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;        dvector catch_sd = sqrt( log( 1.0+square(catch_cv(k)) ) );</div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;        nloglike(1,k) += dnorm(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga3eb45edd19d01d158f8267ca8fe0e62a" title="predicted catch (Baranov eq) ">res_catch</a>(k),catch_sd);</div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;    }</div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;    <span class="comment">// 2) Likelihood of the relative abundance data.</span></div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa9e289eddb591991c9bc7321dc5b186b" title="Estimated rec_dev phase ">verbose</a>) COUT(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga704f894a8c0d3e262863341f6eb95e93" title="predicted relative abundance index ">res_cpue</a>(1));</div>
<div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k = 1; k &lt;= nSurveys; k++ )</div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;    {</div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;        dvector cpue_sd = sqrt(log(1.0 + square(cpue_cv(k))));</div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;        nloglike(2,k) += dnorm(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga704f894a8c0d3e262863341f6eb95e93" title="predicted relative abundance index ">res_cpue</a>(k),cpue_sd(k));</div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;    }</div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;    <span class="comment">// 3) Likelihood for size composition data. </span></div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ii = 1; ii &lt;= nSizeComps; ii++)</div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;    {</div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;        dmatrix     O = d3_obs_size_comps(ii);</div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;        dvar_matrix <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6ec7754e2a4d12b5b249462c6d17af05" title="Fishing mortality ">P</a> = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga919b77c84402d3231070eeb331e03432" title="Old shell crabs-at-length. ">d3_pre_size_comps</a>(ii);</div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;        dvar_vector log_effn  = log(exp(log_vn(ii)) * size_comp_sample_size(ii));</div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;        <span class="keywordtype">bool</span> bCmp = bTailCompression(ii);</div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;        <a class="code" href="../../d3/d8c/classacl_1_1negative_log_likelihood.html">acl::negativeLogLikelihood</a> *ploglike;</div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;        <span class="keywordflow">switch</span>(nAgeCompType(ii))</div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;        {</div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;            <span class="keywordflow">case</span> 1:  <span class="comment">// multinomial with fixed or estimated n</span></div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;                ploglike = <span class="keyword">new</span> <a class="code" href="../../d6/d28/classacl_1_1multinomial.html" title="Class for multinomial negative loglikelihood. ">acl::multinomial</a>(O,bCmp);</div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;            <span class="keywordflow">case</span> 2:  <span class="comment">// robust approximation to the multinomial</span></div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;                <span class="keywordflow">if</span>( current_phase() &lt;= 3 || !last_phase() )</div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;                    ploglike = <span class="keyword">new</span> <a class="code" href="../../d6/d28/classacl_1_1multinomial.html" title="Class for multinomial negative loglikelihood. ">acl::multinomial</a>(O,bCmp);</div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;                    ploglike = <span class="keyword">new</span> <a class="code" href="../../df/dea/classacl_1_1robust__multi.html">acl::robust_multi</a>(O,bCmp);</div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;        }</div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;        <span class="comment">// now compute the likelihood.</span></div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;        nloglike(3,ii) += ploglike-&gt;nloglike(log_effn,P);</div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;        <span class="comment">// Compute residuals in the last phase.</span></div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;        <span class="keywordflow">if</span>(last_phase()) </div>
<div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;        {</div>
<div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;            d3_res_size_comps(ii) = ploglike-&gt;residual(log_effn,P);</div>
<div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;        }</div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;    }</div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;    <span class="comment">// 4) Likelihood for recruitment deviations.</span></div>
<div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;    dvariable sigR = mfexp(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gac5d92613d296542b6ca04b6f1e2d2e2e" title="rate parameter for recruitment distribution ">logSigmaR</a>);</div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;    nloglike(4,1)    = dnorm(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gaf6b70811670344074685f5a1eac1ded7" title="initial size devs ">rec_dev</a>,sigR);</div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;    <span class="comment">// 5) Likelihood for growth increment data</span></div>
<div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;    <span class="keywordflow">if</span>( !bUseEmpiricalGrowth &amp;&amp; ( active(theta(7)) || active(theta(8)) ) )</div>
<div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;    {</div>
<div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;        dvar_vector MoltIncPred = <a class="code" href="../../dc/d0a/group___p_r_o_c_e_d_u_r_e___s_e_c_t_i_o_n.html#gab6ce8eaf8d318c1d10155888cd1bb8dc" title="Compute growth increments. ">calc_growth_increments</a>(dPreMoltSize, iMoltIncSex);</div>
<div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;        nloglike(5,1)    = dnorm(log(dMoltInc) - log(MoltIncPred),dMoltIncCV);</div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;    }</div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;    <span class="comment">// |---------------------------------------------------------------------------------|</span></div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;    <span class="comment">// | PENALTIES AND CONSTRAINTS                                                       |</span></div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;    <span class="comment">// |---------------------------------------------------------------------------------|</span></div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;    nlogPenalty.initialize();</div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;    <span class="comment">// 1) Penalty on log_fdev to ensure they sum to zero </span></div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k = 1; k &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga20b8c3de4b867dab041850cf0b25dfb0" title="time step (years) ">nfleet</a>; k++ )</div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;    {</div>
<div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;        dvariable s    = mean(log_fdev(k));</div>
<div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;        nlogPenalty(1) += 10000.0*s*s;</div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;                  s    = mean(log_fdov(k));</div>
<div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;        nlogPenalty(1) += 10000.0*s*s;             </div>
<div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;    }</div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;    <span class="comment">// 2) Penalty on mean F to regularize the solution.</span></div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;    <span class="keywordtype">int</span> irow=1;</div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;    <span class="keywordflow">if</span>(last_phase()) irow=2;</div>
<div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;    dvariable fbar;</div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k = 1; k &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga20b8c3de4b867dab041850cf0b25dfb0" title="time step (years) ">nfleet</a>; k++ )</div>
<div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;    {</div>
<div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;        fbar = mean(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga218e4fe012e1afdab85c09517d890e4f" title="Numbers-at-sex/mature/shell/length. ">ft</a>(k));</div>
<div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;        nlogPenalty(2) += dnorm(fbar,pen_fbar(k),pen_fstd(irow,k));</div>
<div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;    }</div>
<div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;    <span class="comment">// 3) Penalty to constrain M in random walk</span></div>
<div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;    <span class="keywordflow">if</span>( active(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6cd4f76f01d8bf64a6835786b5194266" title="recruitment deviations ">m_dev</a>) )</div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;    {</div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;            nlogPenalty(3) = dnorm(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6cd4f76f01d8bf64a6835786b5194266" title="recruitment deviations ">m_dev</a>,m_stdev);</div>
<div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;    }</div>
<div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;    objfun = sum(nloglike) + sum(nlogPenalty) + sum(priorDensity);</div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;    <span class="keywordflow">if</span>( <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa9e289eddb591991c9bc7321dc5b186b" title="Estimated rec_dev phase ">verbose</a>==2 ) </div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;    {</div>
<div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;        COUT(objfun);</div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;        COUT(nloglike);</div>
<div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;        COUT(nlogPenalty);</div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;        COUT(priorDensity);</div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;    }</div>
<div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga7507930a25ff4d0e9441f9067b09250f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calc_predicted_catch </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculate predicted catch observations. </p>
<p>The function uses the Baranov catch equation to predict the retained and discarded catch.</p>
<p>Assumptions: 1) retained (landed catch) is assume to be newshell male only. 2) discards are all females (new and old) and male only crab. 3) Natural and fishing mortality occur simultaneously. 4) discard is the total number of crab caught and discarded.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">[description]</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>NULL </dd></dl>
<p>Calculate predicted relative abundance and residuals </p>
<dl class="section author"><dt>Author</dt><dd>Steve Martell</dd></dl>
<p>This function uses the conditional mle for q to scale the population to the relative abundance index. Assumed errors in relative abundance are lognormal. Currently assumes that the CPUE index is made up of both retained and discarded crabs.</p>
<p>Question regarding use of shell condition in the relative abundance index. Currenlty there is no shell condition information in the CPUE data, should there be? Similarly, there is no mature immature information, should there be?</p>

<p>Definition at line <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html#l01346">1346</a> of file <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html">gmacs.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;{</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;    <span class="keywordtype">int</span> h,i,j,k,ig;</div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    <span class="keywordtype">int</span> type,unit;</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gacca515e00e0948b4aef06584907e04f7" title="scalers for relative abundance indices (q) ">pre_catch</a>.initialize();</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;    dvariable tmp_ft;</div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;    dvar_vector sel(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;    dvar_vector nal(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);      <span class="comment">// numbers or biomass at length.</span></div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> kk = 1; kk &lt;= nCatchDF; kk++ )</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;    {</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;        <span class="keywordflow">for</span>( j = 1; j &lt;= nCatchRows(kk); j++ )</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;        {   </div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;            i = dCatchData(kk)(j,1);        <span class="comment">// year index</span></div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;            k = dCatchData(kk)(j,3);        <span class="comment">// gear index</span></div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;            h = dCatchData(kk)(j,4);        <span class="comment">// sex index</span></div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;            <span class="comment">// Type of catch (retained = 1, discard = 2)</span></div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;            type = int(dCatchData(kk)(j,7));</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;            <span class="comment">// Units of catch equation (1 = biomass, 2 = numbers)</span></div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;            unit = int(dCatchData(kk)(j,8));</div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;            <span class="comment">// Total catch</span></div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;            <span class="keywordflow">if</span>(h)   <span class="comment">// sex specific </span></div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;            {</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;                nal.initialize();</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;                sel = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga24a2d92bd04b39df15797453566714f1" title="Surival Rate (S=exp(-Z)) ">log_slx_capture</a>(k)(h)(i);</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;                <span class="keywordflow">switch</span>(type)</div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;                {</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;                    <span class="keywordflow">case</span> 1:     <span class="comment">// retained catch</span></div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;                        <span class="comment">// Question here about what the retained catch is.</span></div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;                        <span class="comment">// Should probably include shell condition here as well.</span></div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;                        <span class="comment">// Now assuming both old and new shell are retained.</span></div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;                        sel = exp( sel + log_slx_retaind(k)(h)(i) );</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;                        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> m = 1; m &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga5ed63c324f88eb6a15b3e2b2c136ec70" title="number of shell conditions ">nmature</a>; m++ )</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;                        {   </div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;                            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> o = 1; o &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa47ab609d7d0b95e04a7f35c9364975e" title="number of sexes ">nshell</a>; o++ )</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;                            {</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;                                ig   = pntr_hmo(h,m,o); </div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;                                nal += <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(i);</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;                            }</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;                        }</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;                    <span class="keywordflow">case</span> 2:     <span class="comment">// discard catch</span></div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;                        sel = elem_prod(exp(sel),1.0 - exp( log_slx_retaind(k)(h)(i) ));</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;                        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> m = 1; m &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga5ed63c324f88eb6a15b3e2b2c136ec70" title="number of shell conditions ">nmature</a>; m++ )</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;                        {</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;                            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> o = 1; o &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa47ab609d7d0b95e04a7f35c9364975e" title="number of sexes ">nshell</a>; o++ )</div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;                            {</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;                                ig   = pntr_hmo(h,m,o);</div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;                                nal += <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(i);</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;                            }</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;                        }</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;                }</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;                tmp_ft = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga218e4fe012e1afdab85c09517d890e4f" title="Numbers-at-sex/mature/shell/length. ">ft</a>(k)(h)(i);</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;                nal = (unit==1) ? elem_prod(nal,mean_wt(h)) : nal;</div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;                <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gacca515e00e0948b4aef06584907e04f7" title="scalers for relative abundance indices (q) ">pre_catch</a>(kk)(j) = nal </div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;                        * elem_div(elem_prod(tmp_ft*sel,1.0-exp(-<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga5a43083584974671b2f3d341e101c733" title="Natural mortality ">Z</a>(h)(i))),<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga5a43083584974671b2f3d341e101c733" title="Natural mortality ">Z</a>(h)(i));</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;            }</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;            <span class="keywordflow">else</span>    <span class="comment">// sexes combibed</span></div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;            {</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;                <span class="keywordflow">for</span>( h = 1; h &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabba2a6095b2a11a9007f29453bdc11e6" title="number of gears ">nsex</a>; h++ )</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;                {</div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;                    nal.initialize();</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;                    sel = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga24a2d92bd04b39df15797453566714f1" title="Surival Rate (S=exp(-Z)) ">log_slx_capture</a>(k)(h)(i);</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;                    <span class="keywordflow">switch</span>(type)</div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;                    {</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;                        <span class="keywordflow">case</span> 1:     <span class="comment">// retained catch</span></div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;                            sel = exp( sel + log_slx_retaind(k)(h)(i) );</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;                            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> m = 1; m &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga5ed63c324f88eb6a15b3e2b2c136ec70" title="number of shell conditions ">nmature</a>; m++ )</div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;                            {</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;                                ig   = pntr_hmo(h,m,1); <span class="comment">//indexes new shell.</span></div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;                                nal += <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(i);</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;                            }</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;                        <span class="keywordflow">case</span> 2:     <span class="comment">// discard catch</span></div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;                            sel = </div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;                                elem_prod(exp(sel),1.0 - exp( log_slx_retaind(k)(h)(i) ));</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;                            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> m = 1; m &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga5ed63c324f88eb6a15b3e2b2c136ec70" title="number of shell conditions ">nmature</a>; m++ )</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;                            {</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;                                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> o = 1; o &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa47ab609d7d0b95e04a7f35c9364975e" title="number of sexes ">nshell</a>; o++ )</div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;                                {</div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;                                    ig   = pntr_hmo(h,m,o);</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;                                    nal += <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(i);</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;                                }</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;                            }</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;                    }</div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;                    tmp_ft = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga218e4fe012e1afdab85c09517d890e4f" title="Numbers-at-sex/mature/shell/length. ">ft</a>(k)(h)(i);</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;                    nal = (unit==1) ? elem_prod(nal,mean_wt(h)) : nal;</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;                    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gacca515e00e0948b4aef06584907e04f7" title="scalers for relative abundance indices (q) ">pre_catch</a>(kk)(j) += nal </div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;                            * elem_div(elem_prod(tmp_ft*sel,1.0-exp(-<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga5a43083584974671b2f3d341e101c733" title="Natural mortality ">Z</a>(h)(i))),<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga5a43083584974671b2f3d341e101c733" title="Natural mortality ">Z</a>(h)(i));</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;                }</div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;            }</div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;        }</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;        <span class="comment">// Catch residuals</span></div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;        <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga3eb45edd19d01d158f8267ca8fe0e62a" title="predicted catch (Baranov eq) ">res_catch</a>(kk) = log(obs_catch(kk)) - log(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gacca515e00e0948b4aef06584907e04f7" title="scalers for relative abundance indices (q) ">pre_catch</a>(kk));</div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa9e289eddb591991c9bc7321dc5b186b" title="Estimated rec_dev phase ">verbose</a>)COUT(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gacca515e00e0948b4aef06584907e04f7" title="scalers for relative abundance indices (q) ">pre_catch</a>(kk)(1));</div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;    }</div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="gab57c8791f16f8993c86a02ecc28c6a06"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calc_predicted_composition </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculate predicted size composition data. </p>
<p>Predicted size composition data are given in proportions. Size composition strata:</p>
<ul>
<li>sex</li>
<li>type (retained or discard)</li>
<li>shell condition</li>
<li>mature or immature</li>
</ul>
<p>NB Sitting in a campground on the Orgeon Coast writing this code, with baby Tabitha sleeping on my back.</p>
<p>TODO:</p>
<ul>
<li>add pointers for shell type. DONE</li>
<li>add pointers for maturity state. DONE</li>
</ul>
<p>Jan 5, 2015. Size compostion data can come in a number of forms. Given sex, maturity and 3 shell conditions, there are 12 possible combinations for adding up the numbers at length (nal). Shell Sex Maturity condition Description </p>
<hr/>
<p> Male 0 1 immature, new shell Male 0 2 immature, old shell Male 0 0 immature, new &amp; old shell 1 Male, immature, new shell Male 1 1 mature, new shell Male 1 2 mature, old shell Male 1 0 mature, new &amp; old shell Female 0 1 immature, new shell Female 0 2 immature, old shell Female 0 0 immature, new &amp; old shell Female 1 1 mature, new shell Female 1 2 mature, old shell Female 1 0 mature, new &amp; old shell </p>
<hr/>
<p>Call function to get the appropriate numbers-at-length.</p>
<p>TODO: [ ] Check to ensure new shell old shell is working. [ ] Add maturity component for data sets with mature old and mature new. </p>
<p>Calculate prior density functions for leading parameters.</p>
<ul>
<li>case 0 is a uniform density between the lower and upper bounds.</li>
<li>case 1 is a normal density with mean = p1 and sd = p2</li>
<li>case 2 is a lognormal density with mean = log(p1) and sd = p2</li>
<li>case 3 is a beta density bounded between lb-ub with p1 and p2 as alpha &amp; beta</li>
<li>case 4 is a gamma density with parameters p1 and p2.</li>
</ul>
<p>TODO Make this a generic function. Agrs would be vector of parameters, and matrix of controls </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">theta</td><td>a vector of parameters </td></tr>
    <tr><td class="paramname">C</td><td>matrix of controls (priorType, p1, p2, lb, ub) </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>vector of prior densities for each parameter</dd></dl>

<p>Definition at line <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html#l01579">1579</a> of file <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html">gmacs.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;{</div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;    <span class="keywordtype">int</span> h,i,j,k,ig;</div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;    <span class="keywordtype">int</span> type,shell,bmature ;</div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga919b77c84402d3231070eeb331e03432" title="Old shell crabs-at-length. ">d3_pre_size_comps</a>.initialize();</div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;    dvar_vector dNtmp(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);</div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;    dvar_vector   nal(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);</div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ii = 1; ii &lt;= nSizeComps; ii++ )</div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;    {</div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> jj = 1; jj &lt;= nSizeCompRows(ii); jj++ )</div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;        {</div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;            dNtmp.initialize();</div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;            nal.initialize();</div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;            i        = d3_SizeComps(ii)(jj,-7);     <span class="comment">// year</span></div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;            j        = d3_SizeComps(ii)(jj,-6);     <span class="comment">// seas</span></div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;            k        = d3_SizeComps(ii)(jj,-5);     <span class="comment">// gear</span></div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;            h        = d3_SizeComps(ii)(jj,-4);     <span class="comment">// sex</span></div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;            type     = d3_SizeComps(ii)(jj,-3);     <span class="comment">// retained or discard</span></div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;            shell    = d3_SizeComps(ii)(jj,-2);     <span class="comment">// shell condition</span></div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;            bmature  = d3_SizeComps(ii)(jj,-1);     <span class="comment">// boolean for maturity</span></div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;            <span class="keywordflow">if</span>(h) <span class="comment">// sex specific</span></div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;            {</div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;                dvar_vector sel = exp(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga24a2d92bd04b39df15797453566714f1" title="Surival Rate (S=exp(-Z)) ">log_slx_capture</a>(k)(h)(i));</div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;                dvar_vector ret = exp(log_slx_retaind(k)(h)(i));</div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;                dvar_vector dis = exp(log_slx_discard(k)(h)(i));</div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;                <span class="comment">// dvar_vector tmp = N(h)(i);</span></div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> m = 1; m &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga5ed63c324f88eb6a15b3e2b2c136ec70" title="number of shell conditions ">nmature</a>; m++ )</div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;                {</div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> o = 1; o &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa47ab609d7d0b95e04a7f35c9364975e" title="number of sexes ">nshell</a>; o++ )</div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;                    {</div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;                        ig   = pntr_hmo(h,m,o);</div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;                        <span class="keywordflow">if</span>(shell == 0) nal += <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(i);</div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;                        <span class="keywordflow">if</span>(shell == o) nal += <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(i);</div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;                    }</div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;                }</div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;                dvar_vector tmp = nal;</div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;                <span class="keywordflow">switch</span> (type)</div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;                {</div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;                    <span class="keywordflow">case</span> 1:     <span class="comment">// retained</span></div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;                        dNtmp = elem_prod(tmp,elem_prod(sel,ret));</div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;                    <span class="keywordflow">case</span> 2:     <span class="comment">// discarded</span></div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;                        dNtmp = elem_prod(tmp,elem_prod(sel,dis));</div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;                    <span class="keywordflow">default</span>:  <span class="comment">// both retained and discarded</span></div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;                        dNtmp = elem_prod(tmp,sel);</div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;                }</div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;            }</div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;            <span class="keywordflow">else</span> <span class="comment">// sexes combined in the observations</span></div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;            {</div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;                <span class="keywordflow">for</span>( h = 1; h &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabba2a6095b2a11a9007f29453bdc11e6" title="number of gears ">nsex</a>; h++ )</div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;                {</div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;                    dvar_vector sel = exp(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga24a2d92bd04b39df15797453566714f1" title="Surival Rate (S=exp(-Z)) ">log_slx_capture</a>(k)(h)(i));</div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;                    dvar_vector ret = exp(log_slx_retaind(k)(h)(i));</div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;                    dvar_vector dis = exp(log_slx_discard(k)(h)(i));</div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;                    <span class="comment">// dvar_vector tmp = N(h)(i);</span></div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> m = 1; m &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga5ed63c324f88eb6a15b3e2b2c136ec70" title="number of shell conditions ">nmature</a>; m++ )</div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;                    {</div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;                        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> o = 1; o &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa47ab609d7d0b95e04a7f35c9364975e" title="number of sexes ">nshell</a>; o++ )</div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;                        {</div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;                            ig   = pntr_hmo(h,m,o);</div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;                            <span class="keywordflow">if</span>(shell == 0) nal += <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(i);</div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;                            <span class="keywordflow">if</span>(shell == o) nal += <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(i);</div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;                        }</div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;                    }</div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;                    dvar_vector tmp = nal;</div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;                    <span class="keywordflow">switch</span> (type)</div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;                    {</div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;                        <span class="keywordflow">case</span> 1:</div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;                            dNtmp += elem_prod(tmp,ret);</div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;                        <span class="keywordflow">case</span> 2:</div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;                            dNtmp += elem_prod(tmp,dis);</div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;                        <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;                            dNtmp += elem_prod(tmp,sel);</div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;                    }</div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;                }</div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;            }</div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;            <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga919b77c84402d3231070eeb331e03432" title="Old shell crabs-at-length. ">d3_pre_size_comps</a>(ii)(jj) = dNtmp / sum(dNtmp);</div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;        }</div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;    }</div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga8b2e44a401baa0eb9bac5c30dcf017c4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calc_recruitment_size_distribution </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>calculate size distribution for new recuits. </p>
<p>Based on the gamma distribution, calculates the probability of a new recruit being in size-interval size.</p>
<p>TODO: fix the scale on cumd_gamma distribution so beta rbeta is estimable.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ra</td><td>is the mean of the distribution. </td></tr>
    <tr><td class="paramname">rbeta</td><td>scales the variance of the distribution </td></tr>
  </table>
  </dd>
</dl>
<p>initialiaze populations numbers-at-length in syr </p>
<dl class="section author"><dt>Author</dt><dd>Steve Martell</dd></dl>
<p>This function initializes the populations numbers-at-length in the initial year of the model.</p>
<p>Psuedocode: See note from Dave Fournier.</p>
<p>For the initial numbers-at-lengt a vector of deviates is estimated, one for each size class, and have the option to initialize the model at unfished equilibrium, or some other steady state condition.</p>
<p>Dec 11, 2014. Martell &amp; Ianelli at snowgoose. We had a discussion regarding how to deal with the joint probability of molting and growing to a new size interval for a given length, and the probability of not molting. We settled on using the size-tranistion matrix to represent this joint probability, where the diagonal of the matrix to represent the probability of surviving and molting to a new size interval. The upper diagonal of the size-transition matrix represent the probability of growing to size interval j' given size interval j.</p>
<p>Oldshell crabs are then the column vector of 1-molt_probabiltiy times the numbers-at-length, and the Newshell crabs is the column vector of molt_probability times the number-at-length.</p>
<p>Jan 1, 2015. Changed how the equilibrium calculation is done. Use a numerical approach to solve the newshell oldshell initial abundance.</p>
<p>–––-—————————————————————————————————————————————————————————————————————————-&mdash; Jan 3, 2015. Working with John Levitt on analytical solution instead of the numerical approach. Think we have a soln.</p>
<p>Notation: n = vector of newshell crabs o = vector of oldshell crabs P = diagonal matrix of molting probabilities by size S = diagonal matrix of survival rates by size A = Size transition matrix. r = vector of new recruits (newshell) I = identity matrix.</p>
<p>The following equations represent the dynamics of newshell and oldshell crabs. n = nSPA + oSPA + r (1) o = oS(I-P)A + nS(I-P)A (2) Objective is to solve the above equations for n and o repsectively. Starting with o: o = n(I-P)S[I-(I-P)S]^(-1) (3) next substitute (3) into (1) and solve for n n = nPSA + n(I-P)S[I-(I-P)S]^(-1)PSA + r</p>
<p>let B = [I-(I-P)S]^(-1) </p>
<pre class="fragment">n - nPSA - n(I-P)SBPSA = r
n(I - PSA - (I-P)SBPSA) = r
</pre><p>let C = (I - PSA - (I-P)SBPSA)</p>
<p>then n = C^(-1) r (4) –––-—————————————————————————————————————————————————————————————————————————-&mdash; –––-—————————————————————————————————————————————————————————————————————————-&mdash;</p>

<p>Definition at line <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html#l01145">1145</a> of file <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html">gmacs.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;{</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;    dvariable ralpha = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga707cff90952d778a8fe87fab6cabd602" title="logarithm of initial recruitment(syr). ">ra</a> / <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga1eafc6de99274e8253e2dbdd63f9746e" title="Expected value of recruitment distribution ">rbeta</a>;</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;    dvar_vector x(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>+1);</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l = 1; l &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>+1; l++ )</div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;    {</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;        x(l) = cumd_gamma(size_breaks(l)/<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga1eafc6de99274e8253e2dbdd63f9746e" title="Expected value of recruitment distribution ">rbeta</a>,ralpha);</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    }</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga5b257b9793f2f889ce2b21ec6db4e3d7" title="CV in molting probabilility. ">rec_sdd</a>  = first_difference(x);</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga5b257b9793f2f889ce2b21ec6db4e3d7" title="CV in molting probabilility. ">rec_sdd</a> /= sum(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga5b257b9793f2f889ce2b21ec6db4e3d7" title="CV in molting probabilility. ">rec_sdd</a>);   <span class="comment">// Standardize so each row sums to 1.0</span></div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;<span class="comment"></span>}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga4f38a22aed2071f65143eeedeb247441"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calc_relative_abundance </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculate predicted relative abundance and residuals. </p>
<dl class="section author"><dt>Author</dt><dd>Steve Martell</dd></dl>
<p>This function uses the conditional mle for q to scale the population to the relative abundance index. Assumed errors in relative abundance are lognormal. Currently assumes that the CPUE index is made up of both retained and discarded crabs.</p>
<p>Question regarding use of shell condition in the relative abundance index. Currenlty there is no shell condition information in the CPUE data, should there be? Similarly, there is no mature immature information, should there be? </p>
<p>Calculate predicted size composition data.</p>
<p>Predicted size composition data are given in proportions. Size composition strata:</p>
<ul>
<li>sex</li>
<li>type (retained or discard)</li>
<li>shell condition</li>
<li>mature or immature</li>
</ul>
<p>NB Sitting in a campground on the Orgeon Coast writing this code, with baby Tabitha sleeping on my back.</p>
<p>TODO:</p>
<ul>
<li>add pointers for shell type. DONE</li>
<li>add pointers for maturity state. DONE</li>
</ul>
<p>Jan 5, 2015. Size compostion data can come in a number of forms. Given sex, maturity and 3 shell conditions, there are 12 possible combinations for adding up the numbers at length (nal). Shell Sex Maturity condition Description </p>
<hr/>
<p> Male 0 1 immature, new shell Male 0 2 immature, old shell Male 0 0 immature, new &amp; old shell 1 Male, immature, new shell Male 1 1 mature, new shell Male 1 2 mature, old shell Male 1 0 mature, new &amp; old shell Female 0 1 immature, new shell Female 0 2 immature, old shell Female 0 0 immature, new &amp; old shell Female 1 1 mature, new shell Female 1 2 mature, old shell Female 1 0 mature, new &amp; old shell </p>
<hr/>
<p>Call function to get the appropriate numbers-at-length.</p>
<p>TODO: [ ] Check to ensure new shell old shell is working. [ ] Add maturity component for data sets with mature old and mature new.</p>

<p>Definition at line <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html#l01459">1459</a> of file <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html">gmacs.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;{</div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;    <span class="keywordtype">int</span> g,h,i,j,k,ig;</div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;    <span class="keywordtype">int</span> unit;</div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;    dvar_vector nal(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);  <span class="comment">// numbers at length</span></div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;    dvar_vector sel(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);  <span class="comment">// selectivity at length</span></div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;    <span class="keywordflow">for</span>( k = 1; k &lt;= nSurveys; k++ )</div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;    {</div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;        dvar_vector V(1,nSurveyRows(k));    </div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;        V.initialize();</div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;        <span class="keywordflow">for</span>( j = 1; j &lt;= nSurveyRows(k); j++ )</div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;        {</div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;            nal.initialize();</div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;            i = dSurveyData(k)(j)(1);       <span class="comment">// year index</span></div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;            g = dSurveyData(k)(j)(3);       <span class="comment">// gear index</span></div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;            h = dSurveyData(k)(j)(4);       <span class="comment">//  sex index</span></div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;            unit = dSurveyData(k)(j)(7);    <span class="comment">// units 1==biomass 2==Numbers</span></div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;            <span class="keywordflow">if</span>(h)</div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;            {</div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;                sel = exp(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga24a2d92bd04b39df15797453566714f1" title="Surival Rate (S=exp(-Z)) ">log_slx_capture</a>(g)(h)(i));</div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> m = 1; m &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga5ed63c324f88eb6a15b3e2b2c136ec70" title="number of shell conditions ">nmature</a>; m++ )</div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;                {</div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> o = 1; o &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa47ab609d7d0b95e04a7f35c9364975e" title="number of sexes ">nshell</a>; o++ )</div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;                    {</div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;                        ig   = pntr_hmo(h,m,o);</div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;                        nal +=  (unit==1)? </div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;                                elem_prod(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(i),mean_wt(h)):</div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;                                <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(i);</div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;                    }</div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;                }</div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;                <span class="comment">// switch(unit)</span></div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;                <span class="comment">// {</span></div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;                <span class="comment">//  case 1:</span></div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;                <span class="comment">//      nal=elem_prod(N(h)(i),mean_wt(h));</span></div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;                <span class="comment">//  break;</span></div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;                <span class="comment">//  case 2:</span></div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;                <span class="comment">//      nal=N(h)(i);</span></div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;                <span class="comment">//  break;</span></div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;                <span class="comment">// }</span></div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;                V(j) = nal * sel;</div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;            }</div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;            {</div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;                <span class="keywordflow">for</span>( h = 1; h &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabba2a6095b2a11a9007f29453bdc11e6" title="number of gears ">nsex</a>; h++ )</div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;                {</div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;                    sel = exp(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga24a2d92bd04b39df15797453566714f1" title="Surival Rate (S=exp(-Z)) ">log_slx_capture</a>(g)(h)(i));</div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> m = 1; m &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga5ed63c324f88eb6a15b3e2b2c136ec70" title="number of shell conditions ">nmature</a>; m++ )</div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;                    {</div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;                        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> o = 1; o &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa47ab609d7d0b95e04a7f35c9364975e" title="number of sexes ">nshell</a>; o++ )</div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;                        {</div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;                            ig   = pntr_hmo(h,m,o);</div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;                            nal +=  (unit==1)? </div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;                                    elem_prod(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(i),mean_wt(h)): </div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;                                    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(i);</div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;                        }</div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;                    }</div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;                    <span class="comment">// switch(unit)</span></div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;                    <span class="comment">// {</span></div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;                    <span class="comment">//  case 1:</span></div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;                    <span class="comment">//      nal=elem_prod(N(h)(i),mean_wt(h));</span></div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;                    <span class="comment">//  break;</span></div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;                    <span class="comment">//  case 2:</span></div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;                    <span class="comment">//      nal=N(h)(i);</span></div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;                    <span class="comment">//  break;</span></div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;                    <span class="comment">// }</span></div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;                    V(j) += nal * sel;</div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;                }</div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;            }</div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;        } <span class="comment">// nSurveyRows(k)</span></div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;        dvar_vector zt = log(obs_cpue(k)) - log(V);</div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;        dvariable zbar = mean(zt);</div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;        <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga704f894a8c0d3e262863341f6eb95e93" title="predicted relative abundance index ">res_cpue</a>(k)    = zt - zbar;</div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;        <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gaac9aab7fd112a5cb6f03efd2640a0def" title="vector of estimated recruits ">survey_q</a>(k)    = mfexp(zbar);</div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;        <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga979b0539a7129c70c1bcfe2905558a80" title="catch residuals in log-space ">pre_cpue</a>(k)    = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gaac9aab7fd112a5cb6f03efd2640a0def" title="vector of estimated recruits ">survey_q</a>(k) * V;</div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;    }</div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="gae64626d2c48849a2b93dfbef31a3e56d"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void model_parameters::calc_sdreport </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>calculate sdreport variables in final phase </p>
<p>Initialize model parameters</p>
<p>Set global variable equal to the estimated parameter vectors.</p>
<p>SM: Note if using empirical growth increment data, then alpha and beta Growth parameters should not be estimated. Need to warn the user if the following condition is true: if( bUseEmpiricalGrowth &amp;&amp; ( acitve(alpha) || active(beta) ) )</p>

<p>Definition at line <a class="el" href="../../dd/da9/gmacs_8tpl_source.html#l01063">1063</a> of file <a class="el" href="../../dd/da9/gmacs_8tpl_source.html">gmacs.tpl</a>.</p>
<div class="fragment"><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;    {</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;        <span class="keywordflow">for</span>( l = 1; l &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>; l++ )</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;        {</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;            <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gaf71db134fc9fe7b5356dc9d5bfb164f9" title="relative abundance residuals ">molt_increment</a>(h)(l) = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga83a49f729a94b763359a19498f5b01eb" title="standard deviation of recruitment deviations. ">alpha</a>(h) - <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga3ecbda63cc0db3ec24303fa49f69a0a8" title="intercept for linear growth increment model. ">beta</a>(h) * mid_points(l);</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;        }</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;    }</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="gaa035770d06c219d3c64d64c178289b80"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calc_selectivities </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculate selectivies for each gear. </p>
<dl class="section author"><dt>Author</dt><dd>Steve Martell</dd></dl>
<p>Three selectivities must be accounted for by each fleet. 1) capture probability, 2) retention probability, and 3) release probability.</p>
<p>Maintain the possibility of estimating selectivity independently for each sex; assumes there are data to estimate female selex.</p>
<p>BUG: There should be no retention of female crabs in the directed fishery.</p>
<p>Psuedocode:</p>
<ol type="1">
<li>Loop over each gear:</li>
<li>Create a pointer array with length = number of blocks</li>
<li>Based on slx_type, fill pointer with parameter estimates.</li>
<li>Loop over years and block-in the log_selectivity at mid points. </li>
</ol>
<p>Calculate fishing mortality rates for each fleet.</p>
<p>For each fleet estimate scaler log_fbar and deviates (f_devs).</p>
<p>In the event that there is effort data and catch data, then it's possible to estimate a catchability coefficient and predict the catch for the period of missing catch/discard data. Best option for this would be to use F = q*E, where q = F/E. Then in the objective function, minimize the variance in the estimates of q, and use the mean q to predict catch. Or minimize the first difference and assume a random walk in q.</p>
<p>Note that this function calculates the fishing mortality rate including deaths due to discards. Where lambda is the discard mortality rate.</p>
<p>Note also that Jie estimates F for retained fishery, f for male discards and f for female discards. Not recommended to have separate F' for retained and discard fisheries, but might be ok to have sex-specific F's.</p>
<p>TODO fix discard mortality rate.</p>

<p>Definition at line <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html#l00799">799</a> of file <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html">gmacs.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;{</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    <span class="keywordtype">int</span> h,i,j,k;</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    <span class="keywordtype">int</span> block;</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    dvariable p1,p2;</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    dvar_vector pv;</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga24a2d92bd04b39df15797453566714f1" title="Surival Rate (S=exp(-Z)) ">log_slx_capture</a>.initialize();</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    log_slx_discard.initialize();</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    log_slx_retaind.initialize();</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;    <span class="keywordflow">for</span>( k = 1; k &lt;= nslx; k++ )</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    {   </div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;        block = 1;</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;        <a class="code" href="../../dc/d0a/classcstar_1_1_selex.html" title="An abstract class for Selectivity functions. ">cstar::Selex&lt;dvar_vector&gt;</a> *pSLX[slx_rows(k)-1];</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;        <span class="keywordflow">for</span>( j = 0; j &lt; slx_rows(k); j++ )</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;        {</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;            <span class="keywordflow">switch</span> (slx_type(k))</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;            {</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;            <span class="keywordflow">case</span> 1:  <span class="comment">//coefficients</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;                pv   = mfexp(log_slx_pars(k)(block));</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;                pSLX[j] = <span class="keyword">new</span> <a class="code" href="../../de/d60/classcstar_1_1_selectivity_coefficients.html" title="Selectivity coefficients. ">cstar::SelectivityCoefficients&lt;dvar_vector&gt;</a>(pv);</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;            <span class="keywordflow">case</span> 2:  <span class="comment">//logistic</span></div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;                p1 = mfexp(log_slx_pars(k,block,1));</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;                p2 = mfexp(log_slx_pars(k,block,2));</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;                pSLX[j] = <span class="keyword">new</span> <a class="code" href="../../de/d7b/classcstar_1_1_logistic_curve.html" title="Logistic curve. ">cstar::LogisticCurve&lt;dvar_vector,dvariable&gt;</a>(p1,p2);</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;            <span class="keywordflow">case</span> 3:  <span class="comment">// logistic95</span></div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;                p1 = mfexp(log_slx_pars(k,block,1));</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;                p2 = mfexp(log_slx_pars(k,block,2));</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;                pSLX[j] = <span class="keyword">new</span> <a class="code" href="../../d4/d0a/classcstar_1_1_logistic_curve95.html" title="Logistic curve parameterised with 5% and 95% selectivity. ">cstar::LogisticCurve95&lt;dvar_vector,dvariable&gt;</a>(p1,p2);</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;            }</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;            block ++;</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;        }</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;        <span class="comment">// fill array with selectivity coefficients</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;        j = 0;</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;        <span class="keywordflow">for</span>( h = 1; h &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabba2a6095b2a11a9007f29453bdc11e6" title="number of gears ">nsex</a>; h++ )</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;        {</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;            <span class="keywordflow">for</span>( i = slx_styr(k); i &lt;= slx_edyr(k); i++ )</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;            {</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;                <span class="keywordtype">int</span> kk = fabs(slx_indx(k));   <span class="comment">// gear index</span></div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;                <span class="keywordflow">if</span>(slx_indx(k) &gt; 0)</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;                {</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;                    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga24a2d92bd04b39df15797453566714f1" title="Surival Rate (S=exp(-Z)) ">log_slx_capture</a>(kk)(h)(i) = pSLX[j]-&gt;logSelectivity(mid_points);</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;                }</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;                {</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;                    log_slx_retaind(kk)(h)(i) = pSLX[j]-&gt;logSelectivity(mid_points);</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;                    log_slx_discard(kk)(h)(i) = log(1.0 - exp(log_slx_retaind(kk)(h)(i)));</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;                }</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;            }</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;            <span class="comment">// Increment counter if sex-specific selectivity curves are defined.</span></div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;            <span class="keywordflow">if</span>(slx_bsex(k))  j++;</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;        }</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;        <span class="keyword">delete</span> *pSLX;</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    }</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="gac1a6684e8544e37f2989b1f388c1275f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calc_size_transition_matrix </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calclate the size transtion matrix.  Steven Martell. </p>
<p>Calculates the size transition matrix for each sex based on growth increments, which is a linear function of the size interval, and the scale parameter for the gamma distribution. This function does the proper integration from the lower to upper size bin, where the mode of the growth increment is scaled by the scale parameter.</p>
<p>This function loops over sex, then loops over the rows of the size transition matrix for each sex. The probability of transitioning from size l to size ll is based on the vector molt_increment and the scale parameter. In all there are three parameters that define the size transition matrix (alpha, beta, scale) for each sex.</p>
<p>Modified Dec 11, 2014. Diagonal of the matrix now represents probability of not molting, and upper triangle is the probability of growing to the next size interval given you molted.</p>
<p>Dec 20. Undid the above modification after correspondence with Jack Turnock. He rightly pointed out that it is possible to molt and remain in the same bin interval (if the intervals are sufficiently large).</p>
<p>Jan 11, 2015. Checked cumd_gamma function in ADMB with R. This is the same function as pgamma with the rate parameter set at its default value 1.0. The mean value of the function is the second argument of cumd_gamma, and the vector of quantiles is the first argument. Both arguments are scaled by gscale. </p>
<p>Calculate natural mortality array</p>
<p>Natural mortality (M) is a 3d array for sex, year and size. </p>
<dl class="section return"><dt>Returns</dt><dd>NULL</dd></dl>
<p>todo:</p>
<ul>
<li>Add time varying components</li>
<li>Size-dependent mortality</li>
</ul>

<p>Definition at line <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html#l00987">987</a> of file <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html">gmacs.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;{</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;    <span class="comment">//cout&lt;&lt;&quot;Start of calc_size_transition_matrix&quot;&lt;&lt;endl;</span></div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;    <span class="keywordtype">int</span> h,l,ll;</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;    dvariable dMeanSizeAfterMolt;</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;    dvar_vector psi(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>+1);</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;    dvar_vector sbi(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>+1);</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;    dvar_matrix At(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>,1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga1552a2cce597930be686a3afed42e4f7" title="probability of molting ">size_transition</a>.initialize();</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;    <span class="keywordflow">for</span>( h = 1; h &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabba2a6095b2a11a9007f29453bdc11e6" title="number of gears ">nsex</a>; h++ )</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;    {</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;        At.initialize();</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        sbi = size_breaks / <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga76794bfeba536881d4da72a8d42941c4" title="slope for the linear growth increment model. ">gscale</a>(h);</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;        <span class="keywordflow">for</span>( l = 1; l &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>; l++ )</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;        {</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;            dMeanSizeAfterMolt = (sbi(l) + <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gaf71db134fc9fe7b5356dc9d5bfb164f9" title="relative abundance residuals ">molt_increment</a>(h)(l)) / <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga76794bfeba536881d4da72a8d42941c4" title="slope for the linear growth increment model. ">gscale</a>(h);</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;            psi.initialize();</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;            <span class="keywordflow">for</span>( ll = l; ll &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>+1; ll++ )</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;            {</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;                <span class="keywordflow">if</span>( ll &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>+1 )</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;                {</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;                    psi(ll) = cumd_gamma(sbi(ll),dMeanSizeAfterMolt);</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;                }</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;            }</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;            At(l)(l,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>)  = first_difference(psi(l,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>+1));</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;            At(l)(l,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>)  = At(l)(l,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>) / sum(At(l));</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;        }</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;        <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga1552a2cce597930be686a3afed42e4f7" title="probability of molting ">size_transition</a>(h) = At;</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;    }</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;    <span class="comment">// cout&lt;&lt;&quot;End of calc_size_transition_matrix&quot;&lt;&lt;endl;</span></div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;<span class="comment"></span>}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga9452e86de816c0c965273a0e38033ea6"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calc_total_mortality </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculate total instantaneous mortality rate and survival rate. </p>
<p>\( S = exp(-Z) \) </p>
<dl class="section return"><dt>Returns</dt><dd>NULL </dd></dl>
<p>Calculate the probability of moulting vs carapace width.</p>
<p>Note that the parameters molt_mu and molt cv can only be estimated in cases where there is new shell and old shell data.</p>
<p>Note that the diagonal of the P matrix != 0, otherwise the matrix is singular in inv(P).</p>

<p>Definition at line <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html#l01091">1091</a> of file <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html">gmacs.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;{</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    <span class="keywordtype">int</span> h;</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga5a43083584974671b2f3d341e101c733" title="Natural mortality ">Z</a>.initialize();</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;    S.initialize();</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;    <span class="keywordflow">for</span>( h = 1; h &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabba2a6095b2a11a9007f29453bdc11e6" title="number of gears ">nsex</a>; h++ )</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;    {</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;        <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga5a43083584974671b2f3d341e101c733" title="Natural mortality ">Z</a>(h) = M(h) + <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga55e662f32ff984a525bbd362c2f3d617" title="Total mortality ">F</a>(h);</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = syr; i &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabf19890366959e62b9f5fd444807a2d3" title="initial year ">nyr</a>; i++ )</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;        {</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l = 1; l &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>; l++ )</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;            {</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;                S(h)(i)(l,l) = mfexp(-<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga5a43083584974671b2f3d341e101c733" title="Natural mortality ">Z</a>(h)(i)(l));</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;            }</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;        }</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;    }</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="gaa7ba0662d9d1f96922dad9831a0eba75"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calculate_prior_densities </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculate prior density functions for leading parameters. </p>
<pre class="fragment">  - case 0 is a uniform density between the lower and upper bounds.
  - case 1 is a normal density with mean = p1 and sd = p2
  - case 2 is a lognormal density with mean = log(p1) and sd = p2
  - case 3 is a beta density bounded between lb-ub with p1 and p2 as alpha &amp; beta
  - case 4 is a gamma density with parameters p1 and p2.

  TODO
  Make this a generic function.
  Agrs would be vector of parameters, and matrix of controls
</pre> <dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">theta</td><td>a vector of parameters </td></tr>
    <tr><td class="paramname">C</td><td>matrix of controls (priorType, p1, p2, lb, ub) </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>vector of prior densities for each parameter </dd></dl>
<p>calculate objective function</p>
<p>Likelihood components</p>
<ol type="1">
<li>likelihood of the catch data (assume lognormal error)</li>
<li>likelihood of relative abundance data</li>
<li>likelihood of size composition data</li>
</ol>
<p>Penalty components</p>
<ol type="1">
<li>Penalty on log_fdev to ensure they sum to zero.</li>
<li>Penalty to regularize values of log_fbar.</li>
<li>Penalty to constrain random walk in natural mortaliy rates</li>
</ol>

<p>Definition at line <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html#l01682">1682</a> of file <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html">gmacs.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;{</div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;    <span class="keywordtype">double</span> p1,p2;</div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;    <span class="keywordtype">double</span> lb,ub;</div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;    priorDensity.initialize();</div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 1; i &lt;= ntheta; i++ )</div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;    {</div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;        <span class="comment">// for(int j = 1; j &lt;= ipar_vector(i); j++ )</span></div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;        {</div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;            <span class="keywordtype">int</span> priorType = int(theta_control(i,5));</div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;            p1 = theta_control(i,6);</div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;            p2 = theta_control(i,7);</div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;            <span class="keywordflow">switch</span>(priorType)</div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;            {</div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;                <span class="comment">// uniform</span></div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;                <span class="keywordflow">case</span> 0: </div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;                    priorDensity(i) = -log(1.0 / (p2-p1));</div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;                <span class="comment">// normal</span></div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;                <span class="keywordflow">case</span> 1:</div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;                    priorDensity(i) = dnorm(theta(i),p1,p2);</div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;                <span class="comment">// lognormal</span></div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;                <span class="keywordflow">case</span> 2:</div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;                    priorDensity(i) = dlnorm(theta(i),log(p1),p2);</div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;                <span class="comment">// beta</span></div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;                <span class="keywordflow">case</span> 3:</div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;                    lb = theta_control(i,2);</div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;                    ub = theta_control(i,3);</div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;                    priorDensity(i) = dbeta((theta(i)-lb)/(ub-lb),p1,p2);</div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;                <span class="comment">// gamma</span></div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;                <span class="keywordflow">case</span> 4:</div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;                    priorDensity(i) = dgamma(theta(i),p1,p2);</div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;            }</div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;        }</div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;    }</div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;    <span class="comment">// ---Continue with catchability priors-----------------------</span></div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;    <span class="keywordtype">int</span> iprior = ntheta + 1; </div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1;i&lt;=nSurveys;i++)</div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;    {</div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;        <span class="keywordtype">int</span> itype = int(prior_qtype(i));</div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;        <span class="keywordflow">switch</span>(itype)</div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;        {</div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;            <span class="comment">// Analytical soln, no prior (uniform, uniformative)</span></div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;            <span class="keywordflow">case</span> 0:</div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;            <span class="comment">// Prior on analytical soln, log-normal</span></div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;            <span class="keywordflow">case</span> 1:</div>
<div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;                priorDensity(iprior) = dnorm(log(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gaac9aab7fd112a5cb6f03efd2640a0def" title="vector of estimated recruits ">survey_q</a>(i)),log(prior_qbar(i)),prior_qsd(i));</div>
<div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;        }</div>
<div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;        iprior++;</div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;    }</div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="gae85542b46a8aa3f80a416a544aac0bbd"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void initialize_model_parameters </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize model parameters. </p>
<p>Set global variable equal to the estimated parameter vectors. </p>
<pre class="fragment"> SM:  Note if using empirical growth increment data, then alpha and beta
 Growth parameters should not be estimated.  Need to warn the user
 if the following condition is true:
 if( bUseEmpiricalGrowth &amp;&amp; ( acitve(alpha) || active(beta) ) )</pre> <p>Calculate selectivies for each gear. </p>
<dl class="section author"><dt>Author</dt><dd>Steve Martell</dd></dl>
<p>Three selectivities must be accounted for by each fleet. 1) capture probability, 2) retention probability, and 3) release probability.</p>
<p>Maintain the possibility of estimating selectivity independently for each sex; assumes there are data to estimate female selex.</p>
<p>BUG: There should be no retention of female crabs in the directed fishery.</p>
<p>Psuedocode:</p>
<ol type="1">
<li>Loop over each gear:</li>
<li>Create a pointer array with length = number of blocks</li>
<li>Based on slx_type, fill pointer with parameter estimates.</li>
<li>Loop over years and block-in the log_selectivity at mid points.</li>
</ol>

<p>Definition at line <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html#l00749">749</a> of file <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html">gmacs.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;{</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    <span class="comment">// Get parameters from theta control matrix:</span></div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;    M0        = theta(1);</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga399cfcaa6f8f749cd20fd5bd69f79681" title="natural mortality rate ">logR0</a>     = theta(2);</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga8d892ae3b2fb367d3a65cbfe670462c4" title="logarithm of average recruits(syr+1,nyr) ">logRini</a>   = theta(3);</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga514790be191aaae8beb5addb8bce8b17" title="logarithm of unfished recruits. ">logRbar</a>   = theta(4);</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga707cff90952d778a8fe87fab6cabd602" title="logarithm of initial recruitment(syr). ">ra</a>        = theta(5);</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga1eafc6de99274e8253e2dbdd63f9746e" title="Expected value of recruitment distribution ">rbeta</a>     = theta(6);</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gac5d92613d296542b6ca04b6f1e2d2e2e" title="rate parameter for recruitment distribution ">logSigmaR</a> = theta(7);</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    <span class="comment">// init_bounded_number_vector Grwth(1,nGrwth,Grwth_lb,Grwth_ub,Grwth_phz);</span></div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    <span class="comment">// Get Growth &amp; Molting parameters </span></div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> h=1;h&lt;=<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabba2a6095b2a11a9007f29453bdc11e6" title="number of gears ">nsex</a>;h++)</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    {</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;        <span class="keywordtype">int</span> icnt=h;</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;        <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga83a49f729a94b763359a19498f5b01eb" title="standard deviation of recruitment deviations. ">alpha</a>(h)     = Grwth(icnt);</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;        icnt += <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabba2a6095b2a11a9007f29453bdc11e6" title="number of gears ">nsex</a>;</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;        <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga3ecbda63cc0db3ec24303fa49f69a0a8" title="intercept for linear growth increment model. ">beta</a>(h)      = Grwth(icnt);</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;        icnt += <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabba2a6095b2a11a9007f29453bdc11e6" title="number of gears ">nsex</a>;</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;        <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga76794bfeba536881d4da72a8d42941c4" title="slope for the linear growth increment model. ">gscale</a>(h)    = Grwth(icnt);</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;        icnt += <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabba2a6095b2a11a9007f29453bdc11e6" title="number of gears ">nsex</a>;</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;        <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga3069844c614bbb10dbbd3524697d62d4" title="scale parameter for the gamma distribution. ">molt_mu</a>(h)   = Grwth(icnt);</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;        icnt += <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabba2a6095b2a11a9007f29453bdc11e6" title="number of gears ">nsex</a>;</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;        <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga736952a304ae8a0b15ea2b82e4da551e" title="50% probability of molting at length each year. ">molt_cv</a>(h)   = Grwth(icnt);</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;    }</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;    <span class="keywordflow">if</span>( ! bUseEmpiricalGrowth )</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;    {</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;        <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga83a49f729a94b763359a19498f5b01eb" title="standard deviation of recruitment deviations. ">alpha</a>     = mle_alpha;</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;        <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga3ecbda63cc0db3ec24303fa49f69a0a8" title="intercept for linear growth increment model. ">beta</a>      = mle_beta;</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    }</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga7b4343d51918847f59db06da7b0d0b3c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void model_parameters::simulation_model </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Simulation model. </p>
<p>Uses many of the same routines as the assessment model, over-writes the observed data in memory with simulated data. </p>

<p>Definition at line <a class="el" href="../../dd/da9/gmacs_8tpl_source.html#l02501">2501</a> of file <a class="el" href="../../dd/da9/gmacs_8tpl_source.html">gmacs.tpl</a>.</p>
<div class="fragment"><div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;    {</div>
<div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;        _dmr(k) = dmr(iyr,k);</div>
<div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;    }</div>
<div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;    </div>
<div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;</div>
<div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;    <a class="code" href="../../df/d47/classspr.html">spr</a> *ptrSPR=<span class="keyword">nullptr</span>;</div>
<div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;</div>
<div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;</div>
<div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;</div>
<div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;    <span class="comment">// SPR reference points for a single shell condition.</span></div>
<div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa47ab609d7d0b95e04a7f35c9364975e" title="number of sexes ">nshell</a> == 1)</div>
<div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;    {</div>
<div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;        <a class="code" href="../../df/d47/classspr.html">spr</a> c_spr(_r,spr_lambda,_rx,_wa,_M,_A);</div>
<div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;        ptrSPR = &amp;c_spr;</div>
<div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;    }</div>
<div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;    <span class="comment">// SPR reference points for new and old shell condition.</span></div>
<div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa47ab609d7d0b95e04a7f35c9364975e" title="number of sexes ">nshell</a> == 2)</div>
<div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;    {</div>
<div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;        <a class="code" href="../../df/d47/classspr.html">spr</a> c_spr(_r,spr_lambda,_rx,_wa,_M,_P,_A);</div>
<div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;        ptrSPR = &amp;c_spr;    </div>
<div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;    }</div>
<div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;    spr_fspr = ptrSPR-&gt;<a class="code" href="../../df/d47/classspr.html#ac21f4b9bd58b8cf097e8ece186fa0735" title="Calculate f_spr reference point. ">get_fspr</a>(ifleet,spr_target,_fhk,_sel,_ret,_dmr);</div>
<div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;    spr_bspr = ptrSPR-&gt;get_bspr();</div>
<div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160;</div>
<div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;    <span class="comment">// OFL Calculations</span></div>
<div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;    dvector mmb = value(calc_mmb());</div>
<div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;    <span class="keywordtype">double</span> cuttoff = 0.1;</div>
<div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;    <span class="keywordtype">double</span> limit = 0.25;</div>
<div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;    spr_fofl = ptrSPR-&gt;<a class="code" href="../../df/d47/classspr.html#af73697b13ba0e7887b80d01cd0d29a62" title="Calculate fishing mortality rate for OFL. ">get_fofl</a>(cuttoff,limit,mmb(<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabf19890366959e62b9f5fd444807a2d3" title="initial year ">nyr</a>));</div>
<div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;    spr_cofl = ptrSPR-&gt;<a class="code" href="../../df/d47/classspr.html#afccf9131ac27f116ee38adb492b6c2b4" title="Calculate OFL. ">get_cofl</a>(_N);</div>
<div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;</div>
<div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;    </div>
<div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;</div>
<div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;</div>
<div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;    </div>
<div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;    </div>
<div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;    </div>
<div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;</div>
<div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;RUNTIME_SECTION</div>
<div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;  maximum_function_evaluations 500,  500,   1500, 25000, 25000</div>
<div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;  convergence_criteria        1.e-4, 1.e-4, 1.e-4, 1.e-4, 1.e-4, </div>
<div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;</div>
<div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;</div>
<div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;GLOBALS_SECTION</div>
<div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;<span class="preprocessor">    #include &lt;admodel.h&gt;</span></div>
<div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;<span class="preprocessor">    #include &lt;time.h&gt;</span></div>
<div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;    <span class="comment">//#include &lt;contrib.h&gt;</span></div>
<div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;<span class="preprocessor">    #if defined __APPLE__ || defined __linux</span></div>
<div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;<span class="preprocessor"></span><span class="preprocessor">    #include &quot;./include/libgmacs.h&quot;</span></div>
<div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;<span class="preprocessor">    #if defined _WIN32 || defined _WIN64</span></div>
<div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;<span class="preprocessor"></span><span class="preprocessor">    #include &quot;include\libgmacs.h&quot;</span></div>
<div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;</div>
<div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;    </div>
<div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;    </div>
<div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;    time_t start,finish;</div>
<div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;    <span class="keywordtype">long</span> hour,minute,second;</div>
<div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;    <span class="keywordtype">double</span> elapsed_time;</div>
<div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;</div>
<div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;    <span class="comment">// Define objects for report file, echoinput, etc.</span></div>
<div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;<span class="comment"></span><span class="preprocessor">    #undef REPORT</span></div>
<div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;<span class="preprocessor"></span><span class="preprocessor">    #define REPORT(object) report &lt;&lt; #object &quot;\n&quot; &lt;&lt; setw(8) \</span></div>
<div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;<span class="preprocessor">    &lt;&lt; setprecision(4) &lt;&lt; setfixed() &lt;&lt; object &lt;&lt; endl;</span></div>
<div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;<span class="preprocessor"></span></div><!-- fragment -->
</div>
</div>
<a class="anchor" id="gab3680df9e34f65fca8c25d4f67857108"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void update_population_numbers_at_length </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Update numbers-at-length. </p>
<dl class="section author"><dt>Author</dt><dd>Steve Martell</dd></dl>
<p>Numbers at length are propagated each year for each sex based on the size transition matrix and a vector of size-specifc survival rates. The columns of the size-transition matrix are multiplied by the size-specific survival rate (a sclaer). New recruits are added based on the estimated aveerage recruitment and annual deviate, multiplied by a vector of size-proportions (rec_sdd). </p>
<p>Calculate predicted catch observations</p>
<p>The function uses the Baranov catch equation to predict the retained and discarded catch.</p>
<p>Assumptions: 1) retained (landed catch) is assume to be newshell male only. 2) discards are all females (new and old) and male only crab. 3) Natural and fishing mortality occur simultaneously. 4) discard is the total number of crab caught and discarded.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">[description]</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>NULL</dd></dl>

<p>Definition at line <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html#l01280">1280</a> of file <a class="el" href="../../dd/d2c/gmacs_8cpp_source.html">gmacs.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;{</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;    <span class="keywordtype">int</span> h,i,ig,o,m;</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;    dmatrix Id = identity_matrix(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>); </div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;    dvar_vector rt(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;    dvar_vector  x(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;    dvar_vector  y(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    dvar_matrix t1(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>,1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;    dvar_matrix  A(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>,1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;    dvar_matrix At(1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>,1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gacece24db44313d85a8a1a22119b00807" title="number of maturity types ">nclass</a>);</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;    <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga19c444af05f8f323c313ca49164f4b19" title="recruitment size_density_distribution ">recruits</a>(syr+1,<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabf19890366959e62b9f5fd444807a2d3" title="initial year ">nyr</a>) = mfexp(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga514790be191aaae8beb5addb8bce8b17" title="logarithm of unfished recruits. ">logRbar</a>);</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;    <span class="keywordflow">for</span>( i = syr; i &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gabf19890366959e62b9f5fd444807a2d3" title="initial year ">nyr</a>; i++ )</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;    {</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;        <span class="keywordflow">if</span>( i &gt; syr )</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;        {</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;            <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga19c444af05f8f323c313ca49164f4b19" title="recruitment size_density_distribution ">recruits</a>(i) *= mfexp(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#gaf6b70811670344074685f5a1eac1ded7" title="initial size devs ">rec_dev</a>(i));</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;        }</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;        rt = (0.5 * <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga19c444af05f8f323c313ca49164f4b19" title="recruitment size_density_distribution ">recruits</a>(i)) * <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga5b257b9793f2f889ce2b21ec6db4e3d7" title="CV in molting probabilility. ">rec_sdd</a>;</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;        <span class="keywordflow">for</span>( ig = 1; ig &lt;= <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga2aa83339d9da5c340798336500aab799" title="number of size-classes ">n_grp</a>; ig++ )</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;        {</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;            h = <a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#ga5486e634d10ef3d853cfd9a131db1be8" title="number of sex/newshell/oldshell groups ">isex</a>(ig);</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;            m = imature(ig);</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;            o = ishell(ig);</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;            <span class="keywordflow">if</span>( o == 1 )    <span class="comment">// newshell</span></div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;            {</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;                A  = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga1552a2cce597930be686a3afed42e4f7" title="probability of molting ">size_transition</a>(h) * S(h)(i);</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;                x = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(i);</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;                <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(i+1) = elem_prod(x,diagonal(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6ec7754e2a4d12b5b249462c6d17af05" title="Fishing mortality ">P</a>(h))) * A + rt;</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;            }</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;            <span class="keywordflow">if</span>( o == 2 )    <span class="comment">// oldshell</span></div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;            {</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;                x  = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(i);</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;                y  = <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig-1)(i);</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;                t1 = (Id - <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6ec7754e2a4d12b5b249462c6d17af05" title="Fishing mortality ">P</a>(h)) * S(h)(i);</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;                <span class="comment">// add oldshell non-terminal molts to newshell</span></div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;                <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig-1)(i+1) += elem_prod(x,diagonal(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga6ec7754e2a4d12b5b249462c6d17af05" title="Fishing mortality ">P</a>(h))) * A;</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;                <span class="comment">// oldshell</span></div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;                <a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig)(i+1) = (x+<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(ig-1)(i)) * t1;</div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;            }</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;            <span class="keywordflow">if</span> ( o == 1 &amp;&amp; m == 2 )     <span class="comment">// terminal molt to new shell.</span></div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;            {</div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;            }</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;            <span class="keywordflow">if</span> ( o == 2 &amp;&amp; m == 2 )     <span class="comment">// terminal molt newshell to oldshell.</span></div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;            {</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;            }</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;        }</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;        <span class="comment">// TO BE DEPRECATED</span></div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;    }</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="../../dc/d17/group___d_a_t_a___s_e_c_t_i_o_n.html#gaa9e289eddb591991c9bc7321dc5b186b" title="Estimated rec_dev phase ">verbose</a>) COUT(<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(1)+<a class="code" href="../../d2/dca/group___p_a_r_a_m_e_t_e_r___s_e_c_t_i_o_n.html#ga07f69a6c12073e7b87e9fe4b20b7432e" title="Diagonal matrix of molt probabilities ">d3_N</a>(2));</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Jan 12 2015 16:27:33 for GMACS by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
